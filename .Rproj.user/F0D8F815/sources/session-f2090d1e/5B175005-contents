---
title: "scRNA-Seq Quality Control and Sample Integration"
output: 
  html_document: 
    toc: yes
    toc_float: TRUE
    toc_depth: 2
    theme: cerulean
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = F, 
                      warning = F,
                      message = F,
                      dpi = 600,
                      fig.width = 7,
                      cache = T,
                      dev = "png")

```

# **Load Libraries and Plot Themes**

```{r, echo=F, fig.align= "center", results=T, message=T, warning=T, eval=T}

# Loads all libraries, color schemes, and plot themes

source("Scripts/2.1.processing.libs.themes.R",
       local = knitr::knit_global())


```





# **Integration of 2 Datasets**


```{r, echo=T, fig.align= "center", results=T, message=T, warning=T, eval=T}

#### Integration ####

fun.integration <- function(
    subset1,
    rds.path
    ) {
  
  ## Anchor function
  
  f.anchor.fun <- function(
    s1
    ) {
    
    ## Find integration anchors
    
    data.files.anchor <- FindIntegrationAnchors(
      object.list = s1,
      anchor.features = 4000, 
      dims = 1:50)
    
    return(data.files.anchor)
    
    }
  
  
  ## run for chosen subset
  
  data.files.anchor1 <- f.anchor.fun(
    subset1
    )
  
  
  ## Integration function
  
  d.int.fun <- function(
    x
    ) {
    
    data.files.merged <- IntegrateData(
      anchorset = x,
      dims = 1:50
      )
    
    return(data.files.merged)
    
  }
  
  
  data.files.merged1 <- d.int.fun(
    data.files.anchor1
    )
  
  saveRDS(
    data.files.merged1,
    rds.path
    )
  
  return(data.files.merged1)
  
  }


# Load .rds containing Seurat objects to integrate

sc.orig <- readRDS(
  "Reference.sets/Ken_HBE10xLSAE5codes1mSAE_cls19noLQ15_seurat.rds"
  )

sc.nkx <- readRDS(
  "Analysis/RDS/1_NKX21KO_data_annotated.rds"
  )

sc.nkx2 <- subset(
  sc.nkx,
  subset = Time == "D28"
  )

remove(sc.nkx)

# Perform Integration

d.merged <- fun.integration(
  c(
    sc.orig,
    sc.nkx2
    ),
  "Analysis/RDS/1.all.lsae.data.rds"
  )





```













